name: Deploy 3-Tier App to EKS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: ap-northeast-2
  ECR_BACKEND_REPO: back
  ECR_FRONTEND_REPO: front

permissions:
  id-token: write
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: project1/backend/package.json
    
    - name: Install backend dependencies
      run: |
        cd project1/backend
        npm install
    
    - name: Run backend tests
      run: |
        cd project1/backend
        npm test

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials using OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        role-session-name: GitHubActions-${{ github.run_id }}
        aws-region: ${{ env.AWS_REGION }}
        mask-aws-account-id: false
    
    - name: Verify AWS credentials
      run: |
        echo "=== AWS ìê²© ì¦ëª… í™•ì¸ ==="
        aws sts get-caller-identity
        echo "AWS Region: $AWS_REGION"
        echo "Assumed Role: $(aws sts get-caller-identity --query Arn --output text)"
    
    - name: Login to ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      with:
        registry-type: private
    
    - name: Set ECR registry
      id: ecr-registry
      run: |
        echo "registry=${{ steps.login-ecr.outputs.registry }}" >> $GITHUB_OUTPUT
        echo "ECR Registry: ${{ steps.login-ecr.outputs.registry }}"
    
    - name: Create ECR repositories if they don't exist
      run: |
        # Create backend repository
        aws ecr describe-repositories --repository-names ${{ env.ECR_BACKEND_REPO }} --region ${{ env.AWS_REGION }} || \
        aws ecr create-repository --repository-name ${{ env.ECR_BACKEND_REPO }} --region ${{ env.AWS_REGION }}
        
        # Create frontend repository
        aws ecr describe-repositories --repository-names ${{ env.ECR_FRONTEND_REPO }} --region ${{ env.AWS_REGION }} || \
        aws ecr create-repository --repository-name ${{ env.ECR_FRONTEND_REPO }} --region ${{ env.AWS_REGION }}
    
    - name: Build and push Backend image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        cd project1/backend
        
        # Build image
        docker build -t $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:$IMAGE_TAG .
        docker build -t $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:latest .
        
        # Push images
        docker push $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:$IMAGE_TAG
        docker push $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:latest
        
        echo "Backend image pushed: $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:$IMAGE_TAG"
    
    - name: Build and push Frontend image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        cd project1/frontend
        
        # Build image
        docker build -t $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:$IMAGE_TAG .
        docker build -t $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:latest .
        
        # Push images
        docker push $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:$IMAGE_TAG
        docker push $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:latest
        
        echo "Frontend image pushed: $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:$IMAGE_TAG"
    
    - name: Check EKS cluster availability
      id: check-eks
      run: |
        echo "=== EKS í´ëŸ¬ìŠ¤í„° í™•ì¸ ==="
        
        # í˜„ì¬ AWS ìê²© ì¦ëª… ìƒì„¸ í™•ì¸
        echo "í˜„ì¬ AWS ìê²© ì¦ëª…:"
        aws sts get-caller-identity
        
        # EKS_CLUSTER_NAME Secret í™•ì¸
        if [ -z "${{ secrets.EKS_CLUSTER_NAME }}" ]; then
          echo "âš ï¸  EKS_CLUSTER_NAME Secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          echo "EKS ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
          echo "skip_eks=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "EKS í´ëŸ¬ìŠ¤í„° ì´ë¦„: ${{ secrets.EKS_CLUSTER_NAME }}"
        
        # EKS í´ëŸ¬ìŠ¤í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        if aws eks describe-cluster --region ${{ env.AWS_REGION }} --name "${{ secrets.EKS_CLUSTER_NAME }}" > /dev/null 2>&1; then
          echo "âœ… EKS í´ëŸ¬ìŠ¤í„°ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤."
          
          # EKS í´ëŸ¬ìŠ¤í„° ìƒì„¸ ì •ë³´ í™•ì¸
          echo "EKS í´ëŸ¬ìŠ¤í„° ì •ë³´:"
          aws eks describe-cluster --region ${{ env.AWS_REGION }} --name "${{ secrets.EKS_CLUSTER_NAME }}" --query 'cluster.{Name:name,Status:status,Endpoint:endpoint,Version:version}'
          
          # kubeconfig ì—…ë°ì´íŠ¸ ì‹œë„
          echo "kubeconfig ì—…ë°ì´íŠ¸ ì¤‘..."
          if aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name "${{ secrets.EKS_CLUSTER_NAME }}" --alias github-actions; then
            echo "âœ… kubeconfig ì—…ë°ì´íŠ¸ ì„±ê³µ"
            
            # kubectl ë²„ì „ í™•ì¸
            echo "kubectl ë²„ì „:"
            kubectl version --client
            
            # í˜„ì¬ ì»¨í…ìŠ¤íŠ¸ í™•ì¸
            echo "í˜„ì¬ ì»¨í…ìŠ¤íŠ¸: $(kubectl config current-context)"
            
            # AWS í† í° ìƒì„± í…ŒìŠ¤íŠ¸
            echo "AWS EKS í† í° ìƒì„± í…ŒìŠ¤íŠ¸:"
            if aws eks get-token --cluster-name "${{ secrets.EKS_CLUSTER_NAME }}" --region "${{ env.AWS_REGION }}" > /dev/null 2>&1; then
              echo "âœ… AWS EKS í† í° ìƒì„± ì„±ê³µ"
            else
              echo "âŒ AWS EKS í† í° ìƒì„± ì‹¤íŒ¨"
            fi
            
            # kubectl ì¸ì¦ í…ŒìŠ¤íŠ¸ (ë” ìƒì„¸í•œ ë¡œê¹…)
            echo "kubectl ì¸ì¦ í…ŒìŠ¤íŠ¸ ì¤‘..."
            
            # ë°©ë²• 1: ê¸°ë³¸ kubectl í…ŒìŠ¤íŠ¸
            if timeout 15s kubectl get nodes > /dev/null 2>&1; then
              echo "âœ… kubectl ì¸ì¦ ì„±ê³µ (ê¸°ë³¸ ë°©ë²•) - EKS ë°°í¬ í™œì„±í™”"
              echo "skip_eks=false" >> $GITHUB_OUTPUT
            else
              echo "âŒ ê¸°ë³¸ kubectl ì¸ì¦ ì‹¤íŒ¨, ëŒ€ì•ˆ ë°©ë²• ì‹œë„ ì¤‘..."
              
              # ë°©ë²• 2: ëª…ì‹œì  í† í° ê°±ì‹  í›„ ì¬ì‹œë„
              echo "AWS EKS í† í° ê°±ì‹  ì¤‘..."
              aws eks get-token --cluster-name "${{ secrets.EKS_CLUSTER_NAME }}" --region "${{ env.AWS_REGION }}" > /tmp/token.json || echo "í† í° ê°±ì‹  ì‹¤íŒ¨"
              
              # ë°©ë²• 3: kubeconfig ì¬ìƒì„±
              echo "kubeconfig ì¬ìƒì„± ì¤‘..."
              rm -f ~/.kube/config
              aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name "${{ secrets.EKS_CLUSTER_NAME }}" --alias github-actions-retry
              
              # ì¬ì‹œë„
              if timeout 15s kubectl get nodes > /dev/null 2>&1; then
                echo "âœ… kubectl ì¸ì¦ ì„±ê³µ (ì¬ì‹œë„) - EKS ë°°í¬ í™œì„±í™”"
                echo "skip_eks=false" >> $GITHUB_OUTPUT
              else
                echo "âŒ kubectl ì¸ì¦ ìµœì¢… ì‹¤íŒ¨ - ìƒì„¸ ì§„ë‹¨ ì‹œì‘"
                
                # ìƒì„¸ ì§„ë‹¨
                echo "=== ìƒì„¸ ì§„ë‹¨ ==="
                echo "1. í˜„ì¬ AWS ìê²© ì¦ëª… ì¬í™•ì¸:"
                aws sts get-caller-identity
                
                echo "2. kubectl ì„¤ì • í™•ì¸:"
                kubectl config view --minify || echo "kubectl config í™•ì¸ ì‹¤íŒ¨"
                
                echo "3. í´ëŸ¬ìŠ¤í„° ì—”ë“œí¬ì¸íŠ¸ ì§ì ‘ í…ŒìŠ¤íŠ¸:"
                CLUSTER_ENDPOINT=$(aws eks describe-cluster --region ${{ env.AWS_REGION }} --name "${{ secrets.EKS_CLUSTER_NAME }}" --query 'cluster.endpoint' --output text)
                echo "í´ëŸ¬ìŠ¤í„° ì—”ë“œí¬ì¸íŠ¸: $CLUSTER_ENDPOINT"
                
                echo "4. AWS EKS í† í° ìƒì„± í…ŒìŠ¤íŠ¸:"
                aws eks get-token --cluster-name "${{ secrets.EKS_CLUSTER_NAME }}" --region "${{ env.AWS_REGION }}" --query 'status.token' --output text | head -c 50 || echo "í† í° ìƒì„± ì‹¤íŒ¨"
                echo "..."
                
                echo "5. í´ëŸ¬ìŠ¤í„° ì—°ê²° í…ŒìŠ¤íŠ¸:"
                kubectl cluster-info --request-timeout=10s || echo "í´ëŸ¬ìŠ¤í„° ì—°ê²° ì‹¤íŒ¨"
                
                echo "6. API ì„œë²„ ì§ì ‘ ì ‘ê·¼ í…ŒìŠ¤íŠ¸:"
                kubectl get --raw='/api/v1' --request-timeout=10s || echo "API ì„œë²„ ì ‘ê·¼ ì‹¤íŒ¨"
                
                echo ""
                echo "ğŸ’¡ ECR ì´ë¯¸ì§€ëŠ” ì •ìƒì ìœ¼ë¡œ ë¹Œë“œë˜ì—ˆìŠµë‹ˆë‹¤."
                echo "ğŸ’¡ ë¡œì»¬ì—ì„œ ./manual-deploy.sh ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ ë°°í¬í•˜ì„¸ìš”."
                echo "ğŸ’¡ ë˜ëŠ” ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ ìˆ˜ë™ ë°°í¬:"
                echo "   git pull && ./manual-deploy.sh"
                echo "skip_eks=true" >> $GITHUB_OUTPUT
              fi
            fi
          else
            echo "âŒ kubeconfig ì—…ë°ì´íŠ¸ ì‹¤íŒ¨"
            echo "skip_eks=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "âŒ EKS í´ëŸ¬ìŠ¤í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${{ secrets.EKS_CLUSTER_NAME }}"
          echo "ì‚¬ìš© ê°€ëŠ¥í•œ í´ëŸ¬ìŠ¤í„° ëª©ë¡:"
          aws eks list-clusters --region ${{ env.AWS_REGION }} || echo "í´ëŸ¬ìŠ¤í„° ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          echo "skip_eks=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Deploy to EKS
      if: steps.check-eks.outputs.skip_eks == 'false'
      continue-on-error: true
      id: deploy-eks
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "=== ë°°í¬ ì „ ìµœì¢… í™•ì¸ ==="
        
        # kubectl ëª…ë ¹ì´ ì‘ë™í•˜ëŠ”ì§€ ìµœì¢… í™•ì¸
        if ! timeout 30s kubectl get nodes > /dev/null 2>&1; then
          echo "âŒ kubectl ëª…ë ¹ì´ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          echo "ğŸ”§ í•´ê²° ë°©ë²•:"
          echo "   1. GitHub Secretsì— EKS_CLUSTER_NAME í™•ì¸"
          echo "   2. IAM Role ê¶Œí•œ í™•ì¸"
          echo "   3. aws-auth ConfigMap ì„¤ì • í™•ì¸"
          echo "   4. ë¡œì»¬ì—ì„œ ./manual-deploy.sh ì‹¤í–‰"
          echo "deploy_success=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "âœ… kubectl ì—°ê²° í™•ì¸ë¨. ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."
        
        echo "=== ë°°í¬ íŒŒì¼ ì¤€ë¹„ ==="
        # Create temporary deployment files with updated image tags
        cp project1/backend-deployment.yaml backend-deployment-temp.yaml
        cp project1/frontend-deployment.yaml frontend-deployment-temp.yaml
        
        # Update image tags in deployment files
        sed -i "s|101553892293.dkr.ecr.ap-northeast-2.amazonaws.com/back:latest|$ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:$IMAGE_TAG|g" backend-deployment-temp.yaml
        sed -i "s|101553892293.dkr.ecr.ap-northeast-2.amazonaws.com/front:latest|$ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:$IMAGE_TAG|g" frontend-deployment-temp.yaml
        
        echo "=== ë°°í¬ íŒŒì¼ ë‚´ìš© í™•ì¸ ==="
        echo "Backend ì´ë¯¸ì§€: $(grep 'image:' backend-deployment-temp.yaml | head -1)"
        echo "Frontend ì´ë¯¸ì§€: $(grep 'image:' frontend-deployment-temp.yaml | head -1)"
        
        echo "=== Kubernetes ë¦¬ì†ŒìŠ¤ ë°°í¬ ==="
        
        # ê° ë¦¬ì†ŒìŠ¤ë¥¼ ê°œë³„ì ìœ¼ë¡œ ë°°í¬
        DEPLOY_SUCCESS=true
        
        echo "1. Database config ë°°í¬..."
        if timeout 60s kubectl apply -f project1/database-config.yaml --validate=false; then
          echo "âœ… Database config ë°°í¬ ì„±ê³µ"
        else
          echo "âŒ Database config ë°°í¬ ì‹¤íŒ¨"
          DEPLOY_SUCCESS=false
        fi
        
        echo "2. Backend deployment ë°°í¬..."
        if timeout 60s kubectl apply -f backend-deployment-temp.yaml --validate=false; then
          echo "âœ… Backend deployment ë°°í¬ ì„±ê³µ"
        else
          echo "âŒ Backend deployment ë°°í¬ ì‹¤íŒ¨"
          DEPLOY_SUCCESS=false
        fi
        
        echo "3. Frontend deployment ë°°í¬..."
        if timeout 60s kubectl apply -f frontend-deployment-temp.yaml --validate=false; then
          echo "âœ… Frontend deployment ë°°í¬ ì„±ê³µ"
        else
          echo "âŒ Frontend deployment ë°°í¬ ì‹¤íŒ¨"
          DEPLOY_SUCCESS=false
        fi
        
        echo "4. Ingress ë°°í¬..."
        if timeout 60s kubectl apply -f project1/ingress.yaml --validate=false; then
          echo "âœ… Ingress ë°°í¬ ì„±ê³µ"
        else
          echo "âŒ Ingress ë°°í¬ ì‹¤íŒ¨"
          DEPLOY_SUCCESS=false
        fi
        
        # Clean up temporary files
        rm -f backend-deployment-temp.yaml frontend-deployment-temp.yaml
        
        if [ "$DEPLOY_SUCCESS" = "true" ]; then
          echo "âœ… ëª¨ë“  ë¦¬ì†ŒìŠ¤ ë°°í¬ ì„±ê³µ"
          echo "deploy_success=true" >> $GITHUB_OUTPUT
          
          echo "=== ë°°í¬ ìƒíƒœ í™•ì¸ ==="
          timeout 30s kubectl get deployments || echo "Deployment ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨"
          timeout 30s kubectl get pods || echo "Pod ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨"
          
          echo "=== ë°°í¬ ì™„ë£Œ ëŒ€ê¸° ==="
          kubectl rollout status deployment/backend --timeout=600s || echo "Backend ë°°í¬ íƒ€ì„ì•„ì›ƒ (ì •ìƒì¼ ìˆ˜ ìˆìŒ)"
          kubectl rollout status deployment/frontend --timeout=600s || echo "Frontend ë°°í¬ íƒ€ì„ì•„ì›ƒ (ì •ìƒì¼ ìˆ˜ ìˆìŒ)"
          
          echo "âœ… ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ"
        else
          echo "âŒ ì¼ë¶€ ë¦¬ì†ŒìŠ¤ ë°°í¬ ì‹¤íŒ¨"
          echo "deploy_success=false" >> $GITHUB_OUTPUT
        fi
        kubectl get pods --timeout=30s || echo "Pod ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨"
        
        echo "=== ë°°í¬ ì™„ë£Œ ëŒ€ê¸° (ê´€ëŒ€í•œ íƒ€ì„ì•„ì›ƒ) ==="
        kubectl rollout status deployment/backend --timeout=600s || echo "Backend ë°°í¬ íƒ€ì„ì•„ì›ƒ (ì •ìƒì¼ ìˆ˜ ìˆìŒ)"
        kubectl rollout status deployment/frontend --timeout=600s || echo "Frontend ë°°í¬ íƒ€ì„ì•„ì›ƒ (ì •ìƒì¼ ìˆ˜ ìˆìŒ)"
        
        echo "âœ… ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ"
    
    - name: Verify deployment
      if: steps.check-eks.outputs.skip_eks == 'false'
      continue-on-error: true
      run: |
        echo "=== ë°°í¬ ê²€ì¦ ì‹œì‘ ==="
        
        # kubectl ì—°ê²° ìƒíƒœ í™•ì¸
        if ! timeout 30s kubectl get nodes > /dev/null 2>&1; then
          echo "âŒ kubectl ì—°ê²° ì‹¤íŒ¨. ë°°í¬ ê²€ì¦ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          echo "ë¡œì»¬ì—ì„œ ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”:"
          echo "kubectl get pods"
          echo "kubectl get deployments"
          echo "kubectl get svc"
          echo "kubectl get ingress"
          exit 0
        fi
        
        echo "âœ… kubectl ì—°ê²° ì„±ê³µ. ë°°í¬ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤."
        
        # ë°°í¬ ìƒíƒœ í™•ì¸ (íƒ€ì„ì•„ì›ƒ ì ìš©)
        echo "Deployments ìƒíƒœ:"
        timeout 30s kubectl get deployments || echo "Deployments ì¡°íšŒ ì‹¤íŒ¨"
        
        echo "Pods ìƒíƒœ:"
        timeout 30s kubectl get pods -l app=backend || echo "Backend Pods ì¡°íšŒ ì‹¤íŒ¨"
        timeout 30s kubectl get pods -l app=frontend || echo "Frontend Pods ì¡°íšŒ ì‹¤íŒ¨"
        
        echo "Services ìƒíƒœ:"
        timeout 30s kubectl get svc || echo "Services ì¡°íšŒ ì‹¤íŒ¨"
        
        echo "Ingress ìƒíƒœ:"
        timeout 30s kubectl get ingress || echo "Ingress ì¡°íšŒ ì‹¤íŒ¨"
        
        echo "=== ë°°í¬ ê²€ì¦ ì™„ë£Œ ==="
        
    - name: Run smoke tests
      if: steps.check-eks.outputs.skip_eks == 'false'
      continue-on-error: true
      run: |
        echo "=== ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹œì‘ ==="
        
        # kubectl ì—°ê²° í™•ì¸
        if ! timeout 30s kubectl get ingress app-ingress > /dev/null 2>&1; then
          echo "âŒ kubectl ì—°ê²° ì‹¤íŒ¨. ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
          echo "ìˆ˜ë™ìœ¼ë¡œ ë‹¤ìŒ URLì—ì„œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”:"
          echo "http://k8s-default-appingre-222592a3d4-1345966544.ap-northeast-2.elb.amazonaws.com"
          exit 0
        fi
        
        # Load Balancer URL ê°€ì ¸ì˜¤ê¸°
        LB_URL=$(timeout 30s kubectl get ingress app-ingress -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
        
        if [ -z "$LB_URL" ]; then
          echo "âš ï¸  Load Balancer URLì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          echo "ìˆ˜ë™ìœ¼ë¡œ ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”:"
          echo "kubectl get ingress app-ingress"
          exit 0
        fi
        
        echo "âœ… Load Balancer URL: http://$LB_URL"
        
        # Load Balancer ì¤€ë¹„ ëŒ€ê¸°
        echo "Load Balancer ì¤€ë¹„ ëŒ€ê¸° ì¤‘... (60ì´ˆ)"
        sleep 60
        
        # Backend health check
        echo "Backend health check í…ŒìŠ¤íŠ¸..."
        if curl -f --connect-timeout 10 --max-time 30 "http://$LB_URL/api/health"; then
          echo "âœ… Backend health check ì„±ê³µ"
        else
          echo "âš ï¸  Backend health check ì‹¤íŒ¨ (ì •ìƒì¼ ìˆ˜ ìˆìŒ - ë¡œë“œë°¸ëŸ°ì„œ ì¤€ë¹„ ì¤‘)"
        fi
        
        # Frontend check
        echo "Frontend í…ŒìŠ¤íŠ¸..."
        if curl -f --connect-timeout 10 --max-time 30 "http://$LB_URL/"; then
          echo "âœ… Frontend ì ‘ê·¼ ì„±ê³µ"
        else
          echo "âš ï¸  Frontend ì ‘ê·¼ ì‹¤íŒ¨ (ì •ìƒì¼ ìˆ˜ ìˆìŒ - ë¡œë“œë°¸ëŸ°ì„œ ì¤€ë¹„ ì¤‘)"
        fi
        
        echo "=== ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ==="
        echo "ì• í”Œë¦¬ì¼€ì´ì…˜ URL: http://$LB_URL"
    
    - name: Summary
      run: |
        echo "=== ğŸš€ ë°°í¬ ìš”ì•½ ==="
        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ ì™„ë£Œ"
        echo "   - Backend: ${{ steps.login-ecr.outputs.registry }}/back:${{ github.sha }}"
        echo "   - Frontend: ${{ steps.login-ecr.outputs.registry }}/front:${{ github.sha }}"
        
        if [ "${{ steps.check-eks.outputs.skip_eks }}" == "true" ]; then
          echo ""
          echo "âš ï¸  EKS ë°°í¬ ê±´ë„ˆëœ€"
          echo "ğŸ“‹ EKS ë°°í¬ë¥¼ ìœ„í•œ ì²´í¬ë¦¬ìŠ¤íŠ¸:"
          echo "   1. EKS í´ëŸ¬ìŠ¤í„°ê°€ ìƒì„±ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸"
          echo "   2. GitHub Secretsì— EKS_CLUSTER_NAME ì„¤ì •"
          echo "   3. IAM Roleì— EKS ê¶Œí•œ ì¶”ê°€"
          echo "   4. aws-auth ConfigMapì— GitHub Actions Role ì¶”ê°€"
          echo ""
          echo "ğŸ”§ ìˆ˜ë™ ë°°í¬ ë°©ë²•:"
          echo "   ë¡œì»¬ì—ì„œ ë‹¤ìŒ ëª…ë ¹ ì‹¤í–‰:"
          echo "   ./manual-deploy.sh"
        else
          echo ""
          echo "ğŸ¯ EKS ë°°í¬ ì‹œë„ ì™„ë£Œ"
          echo "ğŸ“± ì• í”Œë¦¬ì¼€ì´ì…˜ ì ‘ê·¼:"
          echo "   URL: http://k8s-default-appingre-222592a3d4-1345966544.ap-northeast-2.elb.amazonaws.com"
          echo ""
          echo "ğŸ” ë°°í¬ ìƒíƒœ í™•ì¸:"
          echo "   kubectl get pods"
          echo "   kubectl get deployments"
          echo "   kubectl get svc"
          echo "   kubectl get ingress"
          echo ""
          echo "ğŸ“ ë¡œê·¸ í™•ì¸:"
          echo "   kubectl logs -l app=backend"
          echo "   kubectl logs -l app=frontend"
        fi
        
        echo ""
        echo "âœ¨ GitHub Actions ì›Œí¬í”Œë¡œìš° ì™„ë£Œ!"
        
